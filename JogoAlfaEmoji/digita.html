<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jogo de Digitar - Alfabetiza√ß√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #f0f9ff;
            background-image: radial-gradient(#bae6fd 2px, transparent 2px);
            background-size: 30px 30px;
            overflow-x: hidden;
        }
        
        /* --- ESTILOS DO JOGO --- */
        .letter-box {
            transition: all 0.2s;
            text-transform: uppercase;
            cursor: default;
            user-select: none;
        }
        .correct {
            background-color: #86efac !important;
            border-color: #22c55e !important;
            color: #14532d;
            transform: scale(1.05);
        }
        .incorrect {
            background-color: #fca5a5 !important;
            border-color: #ef4444 !important;
            animation: shake 0.4s ease-in-out;
        }
        .active-box {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
            transform: scale(1.1);
            background-color: #fff;
            z-index: 10;
        }
        .filled-static {
            background-color: #e5e7eb; 
            color: #9ca3af; 
            border-color: #d1d5db;
        }

        /* --- NOVO ESTILO DO TECLADO --- */
        #keyboardContainer {
            width: 100%;
            max-width: 1000px;
            padding: 10px 0 30px 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 0 auto;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .key {
            width: 8.5vw; 
            max-width: 85px; 
            height: 72px; 
            
            border-radius: 12px;
            font-size: 2.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s, background-color 0.2s;
            touch-action: manipulation;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            
            background-color: #fff;
            color: #9ca3af;
            border-bottom: 4px solid #d1d5db;
            box-shadow: 0 4px 0 #9ca3af;
        }

        .key:active, .key.active-press {
            transform: translateY(6px);
            box-shadow: none !important;
            border-bottom: 0 !important;
        }
        
        .key-learned {
            background-color: #eff6ff;
            color: #1e40af;
            border-bottom: 4px solid #3b82f6;
            box-shadow: 0 6px 0 #1d4ed8;
        }

        .key-learned:active, .key-learned.active-press {
            background-color: #bfdbfe !important;
        }

        /* --- √ÅREA DE IMAGEM --- */
        .image-monitor {
            background: white;
            border: 4px solid #3b82f6;
            border-radius: 1rem;
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .image-monitor:active {
            transform: scale(0.98);
        }
        .sound-hint {
            position: absolute;
            top: 8px;
            right: 8px;
            color: #3b82f6;
            opacity: 0.6;
        }

        /* --- S√çLABAS INTRO --- */
        .syllable-card {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .syllable-card:hover {
            transform: scale(1.1) rotate(2deg);
            color: #2563eb;
            border-color: #2563eb;
        }

        /* --- CONFETES --- */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        /* --- Layout novo para o topo --- */
        .top-stats-container {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 10px 20px;
            margin-bottom: 10px;
        }

        .stat-box {
            background: white;
            padding: 10px 15px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-bottom: 4px solid;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start select-none pt-2">

    <canvas id="confetti-canvas"></canvas>

    <div class="top-stats-container">
        <div class="stat-box border-blue-200">
            <span class="text-xs text-gray-500 font-bold uppercase">Fase</span>
            <span id="levelDisplay" class="text-xl md:text-2xl font-bold text-blue-600">...</span>
        </div>

        <div class="flex gap-3">
             <div class="stat-box border-gray-200 hidden md:flex">
                <span class="text-[10px] text-gray-500 font-bold uppercase">Precis√£o</span>
                <span id="accuracyDisplay" class="text-lg font-bold text-green-500">100%</span>
             </div>
            <div class="stat-box border-yellow-200 flex-row gap-2 items-center">
                <span class="text-xl">‚≠ê</span>
                <span id="scoreDisplay" class="text-2xl font-bold text-yellow-500">0</span>
            </div>
        </div>
    </div>

    <div id="introArea" class="hidden bg-white rounded-3xl shadow-xl p-8 max-w-3xl w-full text-center border-4 border-yellow-300 mt-2 mx-4">
        <h2 id="introTitle" class="text-2xl font-bold text-blue-600 mb-6">Vamos conhecer a fam√≠lia?</h2>
        <div class="flex justify-center gap-4 text-5xl md:text-6xl font-bold text-gray-700 mb-8 flex-wrap" id="introContainer">
            </div>
        <button onclick="endIntro()" class="bg-green-500 text-white text-xl font-bold py-3 px-8 rounded-xl shadow-[0_4px_0_rgb(21,128,61)] active:translate-y-1 hover:scale-105 transition transform">
            Continuar ‚ûî
        </button>
    </div>

    <div id="presentationArea" class="hidden bg-white rounded-3xl shadow-xl p-6 max-w-3xl w-full text-center border-4 border-purple-300 mt-2 mx-4">
        <h2 class="text-xl md:text-2xl font-bold text-purple-600 mb-4">Observe as palavras:</h2>
        
        <div id="presContent" class="flex flex-col items-center gap-4 justify-center">
            <div class="image-monitor w-64 h-48 md:w-80 md:h-56 bg-white mx-auto">
                <div id="presImageContainer" class="w-full h-full flex items-center justify-center p-4"></div>
            </div>
            <div id="presWord" class="text-4xl md:text-5xl font-bold text-gray-700 tracking-widest mt-2"></div>
        </div>

        <button id="presNextBtn" onclick="nextPresentationItem()" class="mt-6 bg-purple-500 text-white text-xl font-bold py-3 px-8 rounded-xl shadow-[0_4px_0_rgb(107,33,168)] active:translate-y-1 hover:scale-105 transition transform">
            Pr√≥ximo ‚ûî
        </button>
    </div>

    <div id="gameArea" class="hidden bg-white rounded-3xl shadow-xl p-4 max-w-3xl w-full text-center border-4 border-white relative mt-0 flex flex-col items-center mx-4">
        
        <div class="absolute top-0 left-0 w-full h-2 bg-gray-100 rounded-t-3xl overflow-hidden">
            <div id="progressBar" class="h-full bg-green-500 transition-all duration-500" style="width: 0%"></div>
        </div>

        <div id="phaseInstruction" class="text-lg md:text-xl font-bold text-blue-500 mb-2 mt-2 min-h-[1.75rem]"></div>

        <div class="image-monitor w-full max-w-sm h-40 md:h-52 mb-4" onclick="playCurrentAudio()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 sound-hint" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
            </svg>
            <div id="imageContainer" class="w-full h-full flex items-center justify-center p-2"></div>
        </div>

        <div id="inputContainer" class="flex flex-wrap justify-center gap-2 mb-4 min-h-[60px]"></div>

        <div class="h-14 flex items-center justify-center relative w-full mb-2">
            <div id="feedbackMessage" class="text-xl md:text-2xl font-bold text-gray-600 absolute transition-opacity duration-300"></div>
            <button id="nextButton" onclick="nextGameItem()" class="hidden z-10 bg-green-500 hover:bg-green-400 text-white text-xl font-bold py-2 px-8 rounded-xl shadow-[0_4px_0_rgb(21,128,61)] active:translate-y-1 active:shadow-none animate__animated animate__bounceIn">
                Pr√≥xima ‚ûî
            </button>
        </div>
    </div>

    <div id="keyboardContainer" class="hidden select-none">
        </div>

    <div id="phaseSuccessModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-3xl shadow-2xl text-center max-w-sm mx-4 animate__animated animate__zoomIn border-4 border-blue-400">
            <div class="text-7xl mb-4">üåü</div>
            <h2 class="text-3xl font-bold text-blue-600 mb-2">Muito Bem!</h2>
            <p class="text-gray-600 mb-6 text-lg">Voc√™ completou as s√≠labas!</p>
            <p class="text-gray-500 mb-6">Agora vamos escrever as <b>palavras inteiras</b>?</p>
            <button onclick="advanceToFullWordPhase()" class="w-full bg-blue-500 hover:bg-blue-400 text-white text-xl font-bold py-4 px-8 rounded-xl shadow-[0_4px_0_rgb(30,58,138)] active:translate-y-1 transform transition hover:scale-105">
                Vamos l√°! üöÄ
            </button>
        </div>
    </div>

    <div id="levelUpModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-3xl shadow-2xl text-center max-w-sm mx-4 animate__animated animate__zoomIn border-4 border-yellow-400">
            <div class="text-7xl mb-4">üèÜ</div>
            <h2 class="text-3xl font-bold text-blue-600 mb-2">Fase Completa!</h2>
            <p class="text-gray-600 mb-6 text-lg">Voc√™ mandou muito bem!</p>
            <p class="text-gray-500 mb-6">Desbloqueou: <span id="unlockedLetterDisplay" class="font-bold text-2xl text-green-600"></span></p>
            <button onclick="closeModalAndNextLevel()" class="w-full bg-yellow-400 hover:bg-yellow-300 text-yellow-900 text-xl font-bold py-4 px-8 rounded-xl shadow-[0_4px_0_rgb(161,98,7)] active:translate-y-1 transform transition hover:scale-105">
                Pr√≥xima Fase üöÄ
            </button>
        </div>
    </div>

    <div id="retryModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-3xl shadow-2xl text-center max-w-sm mx-4 animate__animated animate__shakeX border-4 border-orange-400">
            <div class="text-7xl mb-4">üí™</div>
            <h2 class="text-3xl font-bold text-orange-600 mb-2">Vamos praticar mais?</h2>
            <p class="text-gray-600 mb-6 text-lg">Precisamos acertar pelo menos <b>80%</b> para passar.</p>
            <button onclick="restartCurrentPhase()" class="w-full bg-orange-400 hover:bg-orange-300 text-white text-xl font-bold py-4 px-8 rounded-xl shadow-[0_4px_0_rgb(194,65,12)] active:translate-y-1 transform transition hover:scale-105">
                Tentar de Novo üîÑ
            </button>
        </div>
    </div>

    <audio id="audioPlayer"></audio>
    <audio id="sndCorrect" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>
    <audio id="sndError" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg"></audio>
    <audio id="sndWin" src="https://actions.google.com/sounds/v1/cartoon/clown_horn_surprise.ogg"></audio>
    <audio id="sndLose" src="https://actions.google.com/sounds/v1/cartoon/cartoon_whistle.ogg"></audio>

    <script>
        // --- CONFIGURA√á√ÉO ---
        const pathAudio = "audios/";
        const pathImg = "img/";

        const levels = {
            0: { letter: "Vogais", unlock: ['A','E','I','O','U','√Å','√â','√ç','√ì','√ö','√Ç','√ä','√î','√É','√ï'], syllables: ['A','E','I','O','U'] },
            1: { letter: "B", unlock: ['B'], syllables: ['BA','BE','BI','BO','BU'] },
            2: { letter: "T", unlock: ['T'], syllables: ['TA','TE','TI','TO','TU'] },
            3: { letter: "P", unlock: ['P'], syllables: ['PA','PE','PI','PO','PU'] },
            4: { letter: "D", unlock: ['D'], syllables: ['DA','DE','DI','DO','DU'] },
            5: { letter: "F", unlock: ['F'], syllables: ['FA','FE','FI','FO','FU'] },
            6: { letter: "V", unlock: ['V'], syllables: ['VA','VE','VI','VO','VU'] },
            7: { letter: "M", unlock: ['M'], syllables: ['MA','ME','MI','MO','MU'] },
            8: { letter: "N", unlock: ['N'], syllables: ['NA','NE','NI','NO','NU'] },
            9: { letter: "L", unlock: ['L'], syllables: ['LA','LE','LI','LO','LU'] }
        };

        const database = {
            0: { items: [{ word: "OI", emoji: "üëã" }, { word: "AI", emoji: "ü§ïüó£Ô∏è" }, { word: "EU", image:"eu.png", emoji: "üôã" }, { word: "AU", emoji: "üê∂üó£Ô∏è" }] },
            1: { items: [{ word: "ABA", image: "aba.png", emoji: "üñºÔ∏è" }, { word: "BA√ö", image: "bau.png", emoji: "üì¶" }, { word: "BAB√Å", image: "baba.png", emoji: "üë∂" }, { word: "BOI", emoji: "üêÇ" }, { word: "BEB√ä", emoji: "üë∂" }, { word: "OBA", emoji: "üôå" }, { word: "BOIA", emoji: "üõü" }] },
            2: { items: [{ word: "TATU", image: "tatu.png", emoji: "ü¶î" }, { word: "TUBA", image: "tuba.png", emoji: "üé∫" }, { word: "TUTU", image: "tutu.png", emoji: "ü©∞" }, { word: "BOTE", image: "bote.png", emoji: "üõ∂" }, { word: "T√ÅBUA", image: "tabua.png", emoji: "ü™µ" }, { word: "BOTA", emoji: "üë¢" }, { word: "OITO", emoji: "8Ô∏è‚É£" }, { word: "TEIA", emoji: "üï∏Ô∏è" }] },
            3: { items: [{ word: "PATA", image: "pata.png", emoji: "üêæ" }, { word: "APITO", image: "apito.png", emoji: "üé∫" }, { word: "TAPETE", image: "tapete.png", emoji: "üß∂" }, { word: "PIPA", emoji: "ü™Å" }, { word: "PATO", emoji: "ü¶Ü" }, { word: "P√â", emoji: "ü¶∂" }] },
            4: { items: [{ word: "DADO", emoji: "üé≤" }, { word: "DEDO", emoji: "‚òùÔ∏è" }, { word: "DIA", emoji: "‚òÄÔ∏è" }, { word: "BODE", emoji: "üêê" }] },
            5: { items: [{ word: "FADA", emoji: "üßö" }, { word: "BIFE", emoji: "ü•©" }, { word: "FITA", emoji: "üéóÔ∏è" }, { word: "FOTO", emoji: "üì∑" }, { word: "FIO", emoji: "üßµ" }] },
            6: { items: [{ word: "VOV√ì", emoji: "üëµ" }, { word: "UVA", emoji: "üçá" }, { word: "AVE", emoji: "ü¶Ö" }, { word: "OVO", emoji: "ü•ö" }, { word: "VIVA", emoji: "üéâ" }] },
            7: { items: [ { word: "MIAU", emoji: "üêàüó£Ô∏è" }, { word: "MEIA", emoji: "üß¶" }, { word: "MAPA", emoji: "üó∫Ô∏è" }] },
            8: { items: [{ word: "MENINA", emoji: "üëß" }, { word: "NOVE", emoji: "9Ô∏è‚É£" }, { word: "BON√â", emoji: "üß¢" }, { word: "BANANA", emoji: "üçå" }, { word: "MENINO", emoji: "üë¶" }] },
            9: { items: [{ word: "LUA", emoji: "üåô" }, { word: "LOBO", emoji: "üê∫" }, { word: "BOLA", emoji: "‚öΩ" }, { word: "BALA", emoji: "üç¨" }, { word: "LULA", emoji: "ü¶ë" }] }
        };

        // --- ESTADO ---
        let currentLevel = 0;
        let score = 0;
        let learnedLetters = new Set();
        let gameState = 'INTRO'; 
        let gameSubState = 'SYLLABLE_PHASE';
        let phaseTotalAttempts = 0; 
        let phaseCorrectAttempts = 0;
        let presentationQueue = [];
        let gameQueue = [];
        let currentItem = null;
        let currentBoxIndex = 0;
        let presentationIndex = 0;
        let targetIndices = []; 

        // --- UTILIT√ÅRIOS √ÅUDIO/ARQUIVO ---
        function getAudioFilename(word) {
            return word.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") + ".mp3";
        }
        function getSyllableFilename(word) {
            return word.substring(0, 2).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") + ".mp3";
        }
        function getIntroSyllableFilename(syllable) {
            return syllable.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") + ".mp3";
        }
        function findSyllableIndices(word, levelLetter) {
            const indices = [];
            const regex = new RegExp(`(${levelLetter})[AEOIU√Å√â√ç√ì√ö√É√ï√Ç√ä√î]`, 'i');
            const match = word.match(regex);
            if (match && match.index !== undefined) {
                indices.push(match.index);
                indices.push(match.index + 1);
            } else {
                if (word.toUpperCase().startsWith(levelLetter)) indices.push(0, 1);
            }
            return indices;
        }

        window.onload = function() {
            initLevel(0);
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            document.addEventListener('keydown', (e) => {
                if (gameState !== 'GAME') return;
                const key = e.key.toUpperCase();
                if (/^[A-Z√Å√â√ç√ì√ö√Ç√ä√î√É√ï√á]$/.test(key) || (key >= 'A' && key <= 'Z')) {
                    handleInput(key);
                    highlightKey(key);
                } else if (e.key === "Enter") {
                    if (!document.getElementById('nextButton').classList.contains('hidden')) {
                        nextGameItem();
                    }
                }
            });
        };

        function initLevel(level) {
            currentLevel = level;
            if (!database[level]) { alert("Fim do Jogo!"); currentLevel = 0; }
            
            learnedLetters = new Set();
            for(let i = 0; i <= currentLevel; i++) {
                if(levels[i]) levels[i].unlock.forEach(l => learnedLetters.add(l));
            }

            document.getElementById('levelDisplay').textContent = `${level} - ${levels[currentLevel].letter}`;
            hideAllScreens();
            presentationQueue = [...database[currentLevel].items];
            startIntro();
        }

        function hideAllScreens() {
            document.getElementById('introArea').classList.add('hidden');
            document.getElementById('presentationArea').classList.add('hidden');
            document.getElementById('gameArea').classList.add('hidden');
            document.getElementById('keyboardContainer').classList.add('hidden');
            document.getElementById('levelUpModal').classList.add('hidden');
            document.getElementById('retryModal').classList.add('hidden');
            document.getElementById('phaseSuccessModal').classList.add('hidden');
        }

        function updateAccuracyDisplay() {
            if (phaseTotalAttempts === 0) {
                document.getElementById('accuracyDisplay').textContent = "100%";
                document.getElementById('accuracyDisplay').className = "text-xl font-bold text-green-500";
                return;
            }
            const acc = Math.round((phaseCorrectAttempts / phaseTotalAttempts) * 100);
            document.getElementById('accuracyDisplay').textContent = acc + "%";
            if(acc >= 80) document.getElementById('accuracyDisplay').className = "text-xl font-bold text-green-500";
            else if(acc >= 60) document.getElementById('accuracyDisplay').className = "text-xl font-bold text-yellow-500";
            else document.getElementById('accuracyDisplay').className = "text-xl font-bold text-red-500";
        }

        // --- INTRO & APRESENTA√á√ÉO ---
        function startIntro() {
            gameState = 'INTRO';
            document.getElementById('introArea').classList.remove('hidden');
            
            const titleElem = document.getElementById('introTitle');
            if (currentLevel === 0) titleElem.textContent = "Vamos lembrar as vogais?";
            else titleElem.textContent = `Fam√≠lia da letra ${levels[currentLevel].letter}`;

            const syllables = levels[currentLevel].syllables || [];
            const container = document.getElementById('introContainer');
            container.innerHTML = '';

            syllables.forEach((syl, i) => {
                const span = document.createElement('span');
                span.textContent = syl;
                span.className = "syllable-card inline-block animate__animated animate__bounceIn text-gray-700 bg-white border-2 border-blue-100 rounded-lg px-4 py-2 shadow-sm m-2";
                span.style.animationDelay = `${i * 0.2}s`;
                span.onclick = () => {
                    const audio = new Audio(pathAudio + getIntroSyllableFilename(syl));
                    audio.play().catch(e=>{});
                    span.classList.remove('animate__bounceIn');
                    void span.offsetWidth;
                    span.classList.add('animate__rubberBand', 'text-blue-500', 'border-blue-500');
                    setTimeout(() => span.classList.remove('text-blue-500', 'border-blue-500'), 500);
                };
                container.appendChild(span);
            });
        }
        function endIntro() { document.getElementById('introArea').classList.add('hidden'); startPresentation(); }

        function startPresentation() {
            gameState = 'PRESENTATION';
            presentationIndex = 0;
            document.getElementById('presentationArea').classList.remove('hidden');
            showPresentationItem();
        }
        function showPresentationItem() {
            if (presentationIndex >= presentationQueue.length) {
                document.getElementById('presentationArea').classList.add('hidden');
                if (currentLevel === 0) startFullWordPhase(); else startSyllablePhase();
                return;
            }
            const item = presentationQueue[presentationIndex];
            const imgContainer = document.getElementById('presImageContainer');
            imgContainer.innerHTML = '';
            
            if (item.image) {
                const img = document.createElement('img');
                img.src = pathImg + item.image;
                img.className = "max-h-full max-w-full object-contain animate__animated animate__fadeIn drop-shadow-xl";
                img.onerror = () => { imgContainer.innerHTML = `<span class="text-7xl md:text-8xl animate__animated animate__fadeIn">${item.emoji}</span>`; };
                imgContainer.appendChild(img);
            } else {
                imgContainer.innerHTML = `<span class="text-7xl md:text-8xl animate__animated animate__fadeIn">${item.emoji}</span>`;
            }
            document.getElementById('presWord').textContent = item.word;
            const player = document.getElementById('audioPlayer');
            player.src = pathAudio + getAudioFilename(item.word);
            player.play().catch(()=>{});
        }
        function nextPresentationItem() { presentationIndex++; showPresentationItem(); }

        // --- JOGO ---
        function startSyllablePhase() {
            gameState = 'GAME'; gameSubState = 'SYLLABLE_PHASE';
            resetPhaseStats();
            document.getElementById('gameArea').classList.remove('hidden');
            document.getElementById('keyboardContainer').classList.remove('hidden');
            renderKeyboard();
            nextGameItem();
        }
        function startFullWordPhase() {
            gameState = 'GAME'; gameSubState = 'FULLWORD_PHASE';
            resetPhaseStats();
            document.getElementById('gameArea').classList.remove('hidden');
            document.getElementById('keyboardContainer').classList.remove('hidden');
            renderKeyboard();
            nextGameItem();
        }
        function resetPhaseStats() {
            phaseTotalAttempts = 0; phaseCorrectAttempts = 0;
            updateAccuracyDisplay();
            gameQueue = [...database[currentLevel].items].sort(() => Math.random() - 0.5);
        }

        function nextGameItem() {
            if (gameQueue.length === 0) { checkPhaseEnd(); return; }
            currentItem = gameQueue.pop();
            const total = database[currentLevel].items.length;
            const progress = ((total - gameQueue.length) / total) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;

            if (gameSubState === 'SYLLABLE_PHASE') {
                targetIndices = findSyllableIndices(currentItem.word, levels[currentLevel].letter);
                if (targetIndices.length === 0) {
                     targetIndices = []; for(let i=0; i<currentItem.word.length; i++) targetIndices.push(i);
                }
            } else {
                targetIndices = []; for(let i=0; i<currentItem.word.length; i++) targetIndices.push(i);
            }
            setupGameRound();
        }

        function setupGameRound() {
            currentBoxIndex = targetIndices.length > 0 ? targetIndices[0] : 0;
            document.getElementById('nextButton').classList.add('hidden');
            document.getElementById('feedbackMessage').textContent = '';
            document.getElementById('inputContainer').innerHTML = '';

            const imgContainer = document.getElementById('imageContainer');
            imgContainer.innerHTML = '';
            if (currentItem.image) {
                const img = document.createElement('img');
                img.src = pathImg + currentItem.image;
                img.className = "max-h-full max-w-full object-contain drop-shadow-lg";
                img.onerror = () => { imgContainer.innerHTML = `<span class="text-6xl md:text-8xl">${currentItem.emoji}</span>`; };
                imgContainer.appendChild(img);
            } else {
                // ALTERA√á√ÉO: For√ßando tamanho grande para o emoji na fase do jogo (Igual apresenta√ß√£o)
                const fontSize = "text-7xl md:text-8xl"; 
                imgContainer.innerHTML = `<span class="${fontSize}">${currentItem.emoji}</span>`;
            }

            const instruction = document.getElementById('phaseInstruction');
            if (gameSubState === 'SYLLABLE_PHASE') {
                instruction.textContent = "Complete a s√≠laba:";
                playWordAudio();
            } else { 
                instruction.textContent = "Escreva a palavra:";
                playWordAudio();
            }
            createBoxes(currentItem.word);
        }

        function createBoxes(word) {
            const container = document.getElementById('inputContainer');
            for (let i = 0; i < word.length; i++) {
                const div = document.createElement('div');
                div.className = 'letter-box w-12 h-14 md:w-16 md:h-20 border-4 rounded-xl flex items-center justify-center text-3xl md:text-5xl font-bold shadow-sm';
                div.id = `box-${i}`;
                if (!targetIndices.includes(i)) {
                    div.classList.add('filled-static');
                    div.textContent = word[i];
                } else {
                    div.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
                }
                container.appendChild(div);
            }
            updateActiveBox();
        }

        // --- √ÅUDIO ---
        function playWordAudio() {
            const player = document.getElementById('audioPlayer');
            player.src = pathAudio + getAudioFilename(currentItem.word);
            player.play().catch(()=>{});
        }
        function playSyllableAudio() {
            const player = document.getElementById('audioPlayer');
            player.src = pathAudio + getSyllableFilename(currentItem.word);
            player.play().catch(() => playWordAudio());
        }
        function playCurrentAudio() {
            if (gameState !== 'GAME') return;
            playWordAudio(); 
        }

        // --- INPUT E L√ìGICA ---
        function handleInput(char) {
            if (!document.getElementById('nextButton').classList.contains('hidden')) return;
            while (currentBoxIndex < currentItem.word.length && !targetIndices.includes(currentBoxIndex)) { currentBoxIndex++; }
            if (currentBoxIndex >= currentItem.word.length) return;

            phaseTotalAttempts++;
            const targetChar = currentItem.word[currentBoxIndex];
            const normInput = char.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const normTarget = targetChar.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

            if (normInput === normTarget) {
                phaseCorrectAttempts++;
                const box = document.getElementById(`box-${currentBoxIndex}`);
                box.textContent = targetChar;
                box.classList.remove('active-box');
                box.classList.add('correct', 'animate__animated', 'animate__bounceIn');
                document.getElementById('sndCorrect').currentTime = 0;
                document.getElementById('sndCorrect').play();
                
                currentBoxIndex++;
                while (currentBoxIndex < currentItem.word.length && !targetIndices.includes(currentBoxIndex)) { currentBoxIndex++; }

                if (currentBoxIndex >= currentItem.word.length) {
                    itemComplete();
                } else {
                    updateActiveBox();
                }
            } else {
                const box = document.getElementById(`box-${currentBoxIndex}`);
                box.classList.add('incorrect');
                document.getElementById('sndError').currentTime = 0;
                
                // ALTERA√á√ÉO: Removido o som de erro para evitar est√≠mulo
                // document.getElementById('sndError').play(); 
                
                setTimeout(() => box.classList.remove('incorrect'), 400);
            }
            updateAccuracyDisplay();
        }

        function updateActiveBox() {
            document.querySelectorAll('.letter-box').forEach(b => b.classList.remove('active-box'));
            let tempIndex = currentBoxIndex;
            while (tempIndex < currentItem.word.length && !targetIndices.includes(tempIndex)) { tempIndex++; }
            if (tempIndex < currentItem.word.length) {
                const current = document.getElementById(`box-${tempIndex}`);
                if (current) current.classList.add('active-box');
            }
        }

        function itemComplete() {
            document.getElementById('feedbackMessage').textContent = "MUITO BEM! üéâ";
            document.getElementById('feedbackMessage').className = "text-2xl md:text-3xl font-bold text-green-600 animate__animated animate__fadeInUp";
            document.getElementById('nextButton').classList.remove('hidden');
            document.getElementById('nextButton').focus();
            
            document.getElementById('sndWin').play();
            setTimeout(() => {
                playWordAudio();
            }, 500);

            score += 10;
            document.getElementById('scoreDisplay').textContent = score;
            fireConfetti();
        }

        // --- VERIFICA√á√ÉO FASE ---
        function checkPhaseEnd() {
            const acc = phaseTotalAttempts === 0 ? 0 : (phaseCorrectAttempts / phaseTotalAttempts) * 100;
            if (acc >= 80) {
                if (gameSubState === 'SYLLABLE_PHASE') showPhaseSuccessModal(); else showLevelUp();
            } else {
                showRetryModal();
            }
        }
        function advanceToFullWordPhase() { document.getElementById('phaseSuccessModal').classList.add('hidden'); startFullWordPhase(); }
        function restartCurrentPhase() {
            document.getElementById('retryModal').classList.add('hidden');
            if (gameSubState === 'SYLLABLE_PHASE') startSyllablePhase(); else startFullWordPhase();
        }
        function showPhaseSuccessModal() { document.getElementById('sndWin').play(); document.getElementById('phaseSuccessModal').classList.remove('hidden'); }
        function showLevelUp() { document.getElementById('sndWin').play(); const next = levels[currentLevel + 1]; document.getElementById('unlockedLetterDisplay').textContent = next ? `Letra ${next.letter}` : "Fim!"; document.getElementById('levelUpModal').classList.remove('hidden'); }
        function showRetryModal() { document.getElementById('sndLose').play(); document.getElementById('retryModal').classList.remove('hidden'); }
        function closeModalAndNextLevel() { document.getElementById('levelUpModal').classList.add('hidden'); initLevel(currentLevel + 1); }

        // --- TECLADO GIGANTE E RESPONSIVO ---
        function renderKeyboard() {
            const layout = ["QWERTYUIOP", "ASDFGHJKL", "ZXCVBNM"];
            const container = document.getElementById('keyboardContainer');
            container.innerHTML = '';
            
            layout.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = "keyboard-row"; 
                row.split('').forEach(char => {
                    const btn = document.createElement('button');
                    btn.textContent = char;
                    btn.id = `key-${char}`;
                    
                    let btnClass = "key"; 
                    
                    if (learnedLetters.has(char)) {
                        btnClass += " key-learned";
                    }
                    
                    btn.className = btnClass;
                    btn.onclick = (e) => { e.preventDefault(); handleInput(char); highlightKey(char); };
                    rowDiv.appendChild(btn);
                });
                container.appendChild(rowDiv);
            });
        }
        function highlightKey(char) {
            const btn = document.getElementById(`key-${char}`);
            if (btn) {
                btn.classList.add('active-press');
                setTimeout(() => btn.classList.remove('active-press'), 150);
            }
        }

        // --- CONFETES ---
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function fireConfetti() {
            for (let i = 0; i < 100; i++) {
                particles.push({
                    x: window.innerWidth / 2,
                    y: window.innerHeight / 2,
                    vx: (Math.random() - 0.5) * 15,
                    vy: (Math.random() - 0.5) * 15,
                    size: Math.random() * 8 + 4,
                    color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                    life: 100
                });
            }
            requestAnimationFrame(animateConfetti);
        }

        function animateConfetti() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles = particles.filter(p => p.life > 0);
            
            particles.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.2;
                p.life--;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
            });

            if (particles.length > 0) {
                requestAnimationFrame(animateConfetti);
            }
        }
    </script>
</body>
</html>