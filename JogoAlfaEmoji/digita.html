<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Digita TEA">
    <title>Digita TEA - Seletor de Fases</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #f0f9ff;
            overflow: hidden; 
            -webkit-user-select: none; user-select: none;
            touch-action: manipulation;
        }

        /* --- TOGGLE SWITCH --- */
        .toggle-checkbox:checked { right: 0; border-color: #22c55e; }
        .toggle-checkbox:checked + .toggle-label { background-color: #22c55e; }
        
        /* --- ESTILOS DO JOGO --- */
        .letter-box { transition: all 0.2s; text-transform: uppercase; cursor: default; }
        .correct { background-color: #86efac !important; border-color: #22c55e !important; color: #14532d; transform: scale(1.05); }
        .incorrect { background-color: #fca5a5 !important; border-color: #ef4444 !important; animation: shake 0.4s ease-in-out; }
        .active-box { border-color: #3b82f6 !important; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3); transform: scale(1.1); background-color: #fff; z-index: 10; }
        .filled-static { background-color: #e5e7eb; color: #9ca3af; border-color: #d1d5db; }

        /* Teclado e Bot√µes */
        .key {
            flex: 1; max-width: 90px; height: 60px; border-radius: 12px;
            font-size: 1.8rem; font-weight: bold; cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            display: flex; align-items: center; justify-content: center;
            background-color: #fff; color: #9ca3af; border-bottom: 4px solid #d1d5db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); touch-action: manipulation;
        }
        .key:active, .key.active-press { transform: translateY(4px); border-bottom: 0 !important; background-color: #e5e7eb; }
        .key-learned { background-color: #eff6ff; color: #1e40af; border-bottom: 4px solid #3b82f6; }
        
        /* Dicas */
        .hint-active { background-color: #fef08a !important; border-color: #eab308 !important; transform: scale(1.05); color: #854d0e !important; opacity: 1 !important; }
        .hint-inactive { opacity: 0.3 !important; filter: grayscale(100%); pointer-events: none; }

        /* N√≠veis */
        .level-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .level-card:active {
            transform: scale(0.95);
        }
        .level-locked {
            filter: grayscale(100%);
            opacity: 0.6;
            pointer-events: none;
        }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        /* Scroll customizado para o grid de fases */
        .level-grid-scroll::-webkit-scrollbar { width: 8px; }
        .level-grid-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .level-grid-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .level-grid-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="h-screen w-full flex flex-col bg-blue-50 relative">

    <canvas id="confetti-canvas" class="fixed inset-0 pointer-events-none z-[60]"></canvas>

    <!-- TELA DE SETUP / SELE√á√ÉO DE FASES -->
    <div id="screenSetup" class="absolute inset-0 z-[100] bg-white flex flex-col animate__animated animate__fadeIn">
        <!-- Cabe√ßalho -->
        <div class="bg-blue-500 p-4 shadow-md z-10 shrink-0 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-white">Digita TEA üöÄ</h1>
                <p class="text-blue-100 text-sm">Selecione uma fase</p>
            </div>
            <button onclick="resetProgress()" class="text-xs text-blue-200 bg-blue-600 px-2 py-1 rounded hover:bg-blue-700">
                Limpar Dados
            </button>
        </div>

        <!-- Conte√∫do Principal com Scroll -->
        <div class="flex-1 overflow-y-auto level-grid-scroll p-4 pb-24 bg-blue-50">
            
            <!-- Painel de Configura√ß√µes -->
            <div class="bg-white rounded-2xl p-4 mb-6 border-2 border-blue-100 shadow-sm mx-auto max-w-2xl">
                <div class="flex flex-wrap gap-4 justify-center md:justify-between items-center">
                    
                    <!-- Dificuldade -->
                    <div class="flex flex-col">
                        <span class="text-sm font-bold text-gray-500 mb-1">Dificuldade para passar:</span>
                        <select id="difficultySelect" class="p-2 rounded-lg border-2 border-blue-200 text-gray-600 font-bold bg-blue-50 text-sm">
                            <option value="0">Muito F√°cil (Passa Sempre)</option>
                            <option value="50">F√°cil (> 50%)</option>
                            <option value="70" selected>M√©dio (> 70%)</option>
                            <option value="80">Dif√≠cil (> 80%)</option>
                        </select>
                    </div>

                    <!-- Bot√µes Toggle -->
                    <div class="flex gap-6">
                        <div class="flex flex-col items-center">
                            <span class="text-xs font-bold text-gray-400 mb-1">Dicas Visuais</span>
                            <div class="relative inline-block w-12 align-middle select-none">
                                <input type="checkbox" id="toggleHints" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 ease-in-out border-gray-300 left-0"/>
                                <label for="toggleHints" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>

                        <div class="flex flex-col items-center">
                            <span class="text-xs font-bold text-gray-400 mb-1">Modo Aprender</span>
                            <div class="relative inline-block w-12 align-middle select-none">
                                <input type="checkbox" id="toggleProgressive" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 ease-in-out border-gray-300 left-0"/>
                                <label for="toggleProgressive" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grid de Fases -->
            <div id="levelsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-w-4xl mx-auto">
                <!-- As fases ser√£o geradas aqui via JavaScript -->
            </div>
        </div>
    </div>

    <!-- TELA DE APRESENTA√á√ÉO / TRANSI√á√ÉO -->
    <div id="screenPresentation" class="hidden absolute inset-0 z-[50] bg-white flex flex-col items-center p-4">
        <div class="w-full h-16 flex items-center justify-between border-b border-gray-100 shrink-0 px-4">
            <button onclick="goToMenu()" class="text-gray-400 hover:text-gray-600 font-bold text-sm bg-gray-100 px-3 py-1 rounded-lg">
                ‚¨Ö MENU
            </button>
            <span id="presentationTitle" class="text-gray-400 font-bold uppercase tracking-widest">APRENDENDO</span>
            <div class="w-16"></div> <!-- Espa√ßador para centralizar t√≠tulo -->
        </div>
        <div class="flex-1 flex flex-col items-center justify-center w-full max-w-3xl text-center overflow-y-auto" id="presentationContent"></div>
        <div class="w-full shrink-0 py-6 flex flex-col gap-3 items-center bg-white border-t border-gray-100">
            <button onclick="advanceLinearFlow()" class="w-full max-w-md bg-green-500 text-white text-3xl font-bold py-5 px-8 rounded-2xl shadow-[0_6px_0_rgb(21,128,61)] active:shadow-none active:translate-y-2 transition-all uppercase tracking-widest animate__animated animate__pulse animate__infinite">
                PR√ìXIMO ‚ûî
            </button>
        </div>
    </div>

    <!-- TELA DO JOGO -->
    <div id="screenGame" class="hidden flex-col w-full h-full z-[10]">
        <div class="w-full h-14 bg-blue-50 border-b border-blue-100 flex items-center justify-between px-4 shrink-0 shadow-sm z-30">
            <button onclick="goToMenu()" class="text-blue-400 font-bold hover:bg-blue-100 p-2 rounded-lg transition-colors">
                ‚¨Ö Voltar
            </button>
            <div class="text-sm text-blue-400 font-bold uppercase tracking-wider hidden md:block" id="gameLevelDisplay">N√≠vel 0</div>
            <div class="flex gap-3">
                <div class="flex items-center gap-2 bg-white px-3 py-1 rounded-full border border-blue-200 shadow-sm">
                    <span class="text-lg">‚≠ê</span><span id="scoreDisplay" class="text-blue-600 font-bold">0</span>
                </div>
                <div class="flex items-center gap-2 bg-white px-3 py-1 rounded-full border border-green-200 shadow-sm">
                    <span class="text-lg">üéØ</span><span id="accuracyDisplay" class="text-green-600 font-bold">100%</span>
                </div>
            </div>
        </div>

        <div class="w-full h-2 bg-gray-200 shrink-0">
            <div id="progressBar" class="h-full bg-green-500 transition-all duration-500" style="width: 0%"></div>
        </div>

        <div class="flex-1 flex flex-col items-center justify-center p-2 relative overflow-hidden bg-white/50 w-full">
            
            <div id="gameInstruction" class="text-xl font-bold text-blue-400 mt-2 mb-2 text-center shrink-0">Escreva:</div>

            <div class="flex-1 w-full flex items-center justify-center min-h-0 mb-4 px-4">
                <div class="image-monitor w-full h-full max-w-2xl bg-white border-4 border-blue-400 rounded-3xl relative cursor-pointer hover:scale-[1.01] transition-transform shadow-lg flex items-center justify-center" onclick="playCurrentAudio()">
                    <div id="gameImageContainer" class="w-full h-full flex items-center justify-center p-4"></div>
                    <div class="absolute bottom-2 right-2 bg-blue-100 p-2 rounded-full opacity-60">üîä</div>
                </div>
            </div>

            <div id="inputContainer" class="flex flex-wrap justify-center gap-2 mb-4 shrink-0"></div>

            <div id="successOverlay" class="hidden absolute inset-0 z-40 bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center animate__animated animate__fadeIn">
                <div id="feedbackMessage" class="text-5xl md:text-6xl font-black text-green-500 mb-8 drop-shadow-sm animate__animated animate__rubberBand">MUITO BEM! üéâ</div>
                <button onclick="nextGameItem()" class="bg-green-500 hover:bg-green-400 text-white text-3xl font-bold py-6 px-12 rounded-3xl shadow-[0_10px_0_rgb(21,128,61)] active:shadow-none active:translate-y-2 transition-all uppercase tracking-widest animate__animated animate__pulse animate__infinite">
                    PR√ìXIMO ‚ûî
                </button>
            </div>
        </div>

        <footer id="keyboardArea" class="shrink-0 bg-white border-t border-gray-200 pb-4 pt-2 px-1 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] z-20">
            <div id="keyboardContainer" class="max-w-4xl mx-auto flex flex-col gap-2"></div>
        </footer>
    </div>

    <!-- √Åudios -->
    <audio id="sndCorrect" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>
    <audio id="sndWordWin" src="https://actions.google.com/sounds/v1/cartoon/magic_chime.ogg"></audio>
    <audio id="sndLevelWin" src="audios/fimfase.mp3"></audio>
    <audio id="sndLose" src="https://actions.google.com/sounds/v1/cartoon/cartoon_whistle.ogg"></audio>

    <script>
        document.addEventListener('gesturestart', (e) => e.preventDefault());
        const pathAudio = "audios/";
        const pathImg = "img/";

        // --- DADOS DAS FASES ---
        const levels = {
            0: { title: "Vogais", unlock: ['A','E','I','O','U','√Å','√â','√ç','√ì','√ö','√Ç','√ä','√î','√É','√ï'], syllables: ['A','E','I','O','U'], color: "bg-pink-100 border-pink-300 text-pink-600" },
            1: { title: "Letra B", unlock: ['B'], syllables: ['BA','BE','BI','BO','BU'], color: "bg-blue-100 border-blue-300 text-blue-600" },
            2: { title: "Letra T", unlock: ['T'], syllables: ['TA','TE','TI','TO','TU'], color: "bg-green-100 border-green-300 text-green-600" },
            3: { title: "Letra P", unlock: ['P'], syllables: ['PA','PE','PI','PO','PU'], color: "bg-yellow-100 border-yellow-300 text-yellow-600" },
            4: { title: "Letra D", unlock: ['D'], syllables: ['DA','DE','DI','DO','DU'], color: "bg-purple-100 border-purple-300 text-purple-600" },
            5: { title: "Letra F", unlock: ['F'], syllables: ['FA','FE','FI','FO','FU'], color: "bg-red-100 border-red-300 text-red-600" },
            6: { title: "Letra V", unlock: ['V'], syllables: ['VA','VE','VI','VO','VU'], color: "bg-teal-100 border-teal-300 text-teal-600" },
            7: { title: "Letra M", unlock: ['M'], syllables: ['MA','ME','MI','MO','MU'], color: "bg-orange-100 border-orange-300 text-orange-600" },
            
            // FASE ESPECIAL DE CONTEXTO
            8: { 
                title: "Sons Animais", 
                type: "context", 
                introTitle: "Quem faz esse som?", 
                unlock: [], 
                syllables: ['MIAU','AUAU','MUU','PIU','B√â'], 
                color: "bg-amber-100 border-amber-300 text-amber-800" 
            },

            9: { title: "Letra N", unlock: ['N'], syllables: ['NA','NE','NI','NO','NU'], color: "bg-indigo-100 border-indigo-300 text-indigo-600" },
            10: { title: "Letra L", unlock: ['L'], syllables: ['LA','LE','LI','LO','LU'], color: "bg-lime-100 border-lime-300 text-lime-600" },

            // --- FASES ANTERIORES ---
            11: { title: "Letra J", unlock: ['J'], syllables: ['JA','JE','JI','JO','JU'], color: "bg-cyan-100 border-cyan-300 text-cyan-600" },
            12: { title: "Letra C", unlock: ['C'], syllables: ['CA','CO','CU'], color: "bg-rose-100 border-rose-300 text-rose-600" },
            13: { title: "Letra S", unlock: ['S'], syllables: ['SA','SE','SI','SO','SU'], color: "bg-sky-100 border-sky-300 text-sky-600" },
            14: { title: "Letra R", unlock: ['R'], syllables: ['RA','RE','RI','RO','RU'], color: "bg-fuchsia-100 border-fuchsia-300 text-fuchsia-600" },
            
            // FASE ESPECIAL: CORES
            15: { 
                title: "Cores", 
                type: "context", 
                introTitle: "Que cor √© essa?", 
                unlock: [], 
                syllables: ['AZUL', 'ROSA', 'VERDE'], 
                color: "bg-violet-100 border-violet-300 text-violet-600" 
            },

            16: { title: "Letra G", unlock: ['G'], syllables: ['GA','GO','GU'], color: "bg-emerald-100 border-emerald-300 text-emerald-600" },
            17: { title: "Letra Z", unlock: ['Z'], syllables: ['ZA','ZE','ZI','ZO','ZU'], color: "bg-slate-100 border-slate-300 text-slate-600" },
            18: { title: "Letra X", unlock: ['X'], syllables: ['XA','XE','XI','XO','XU'], color: "bg-zinc-100 border-zinc-300 text-zinc-600" },

            // --- NOVAS FASES (EXPANS√ÉO) ---
            19: { title: "Letra H", unlock: ['H'], syllables: ['HA','HE','HI','HO','HU'], color: "bg-amber-100 border-amber-300 text-amber-600" },
            20: { title: "Letra Q", unlock: ['Q'], syllables: ['QUA','QUE','QUI'], color: "bg-teal-200 border-teal-400 text-teal-800" },
            21: { title: "Letra K", unlock: ['K'], syllables: ['KA','KE','KI','KO','KU'], color: "bg-red-200 border-red-400 text-red-800" },
            22: { title: "Letra W", unlock: ['W'], syllables: ['WA','WE','WI','WO','WU'], color: "bg-blue-200 border-blue-400 text-blue-800" },
            23: { title: "Letra Y", unlock: ['Y'], syllables: ['YA','YE','YI','YO','YU'], color: "bg-purple-200 border-purple-400 text-purple-800" },

            // FASES ESPECIAIS DE CONTEXTO
            24: { 
                title: "Frutas", 
                type: "context", 
                introTitle: "Que fruta √© essa?", 
                unlock: [], 
                syllables: ['UVA', 'MA√á√É', 'PERA'], 
                color: "bg-green-100 border-green-300 text-green-700" 
            },
            25: { 
                title: "Corpo", 
                type: "context", 
                introTitle: "Corpo Humano", 
                unlock: [], 
                syllables: ['M√ÉO', 'P√â', 'BOCA'], 
                color: "bg-orange-100 border-orange-300 text-orange-700" 
            },

            // --- EXPANS√ÉO ADICIONAL (D√≠grafos e Contextos) ---
            26: { title: "CH", unlock: ['C','H'], syllables: ['CHA','CHE','CHI','CHO','CHU'], color: "bg-teal-100 border-teal-300 text-teal-700" },
            27: { title: "LH", unlock: ['L','H'], syllables: ['LHA','LHE','LHI','LHO','LHU'], color: "bg-lime-100 border-lime-300 text-lime-700" },
            28: { title: "NH", unlock: ['N','H'], syllables: ['NHA','NHE','NHI','NHO','NHU'], color: "bg-indigo-100 border-indigo-300 text-indigo-700" },
            
            29: { 
                title: "Transportes", 
                type: "context", 
                introTitle: "Meios de Transporte", 
                unlock: [], 
                syllables: ['CARRO', 'TREM', 'MOTO'], 
                color: "bg-blue-100 border-blue-300 text-blue-700" 
            },
            30: { 
                title: "Escola", 
                type: "context", 
                introTitle: "Material Escolar", 
                unlock: [], 
                syllables: ['L√ÅPIS', 'MESA', 'LIVRO'], 
                color: "bg-yellow-100 border-yellow-300 text-yellow-700" 
            },

            // --- FIM DA EXPANS√ÉO ANTERIOR ---

            // --- NOVA EXPANS√ÉO: MAIS D√çGRAFOS E CONTEXTOS ---
            31: { title: "RR", unlock: ['R'], syllables: ['RRA','RRE','RRI','RRO','RRU'], color: "bg-rose-200 border-rose-400 text-rose-800" },
            32: { title: "SS", unlock: ['S'], syllables: ['SSA','SSE','SSI','SSO','SSU'], color: "bg-slate-200 border-slate-400 text-slate-800" },
            33: { title: "Cedilha √á", unlock: ['√á'], syllables: ['√áA','√áO','√áU'], color: "bg-fuchsia-200 border-fuchsia-400 text-fuchsia-800" },
            
            34: { 
                title: "Casa", 
                type: "context", 
                introTitle: "Objetos de Casa", 
                unlock: [], 
                syllables: ['SOF√Å', 'CAMA', 'PORTA'], 
                color: "bg-orange-50 border-orange-300 text-orange-800" 
            },
            35: { 
                title: "Sentimentos", 
                type: "context", 
                introTitle: "Como voc√™ est√°?", 
                unlock: [], 
                syllables: ['FELIZ', 'TRISTE', 'AMOR'], 
                color: "bg-yellow-200 border-yellow-400 text-yellow-800" 
            },

            // --- EXPANS√ÉO FINAL (AT√â 40) ---
            36: { title: "AR ER IR", unlock: ['R'], syllables: ['AR','ER','IR','OR','UR'], color: "bg-orange-200 border-orange-400 text-orange-800" },
            37: { title: "AL EL IL", unlock: ['L'], syllables: ['AL','EL','IL','OL','UL'], color: "bg-blue-200 border-blue-400 text-blue-800" },
            38: { title: "AN EN IN", unlock: ['N'], syllables: ['AN','EN','IN','ON','UN'], color: "bg-purple-200 border-purple-400 text-purple-800" },
            39: { 
                title: "Natureza", 
                type: "context", 
                introTitle: "Natureza", 
                unlock: [], 
                syllables: ['SOL', 'MAR', 'FLOR'], 
                color: "bg-green-200 border-green-400 text-green-800" 
            },
            40: { 
                title: "A√ß√µes", 
                type: "context", 
                introTitle: "O que est√£o fazendo?", 
                unlock: [], 
                syllables: ['PULAR', 'CORRER', 'RIR'], 
                color: "bg-pink-200 border-pink-400 text-pink-800" 
            }
        };

        const database = {
            0: { items: [
				{ word: "OI", emoji: "üëã" },
				{ word: "AI", emoji: "ü§ïüó£Ô∏è" },
				{ word: "EU", image:"eu.png", emoji: "üôã" },
				{ word: "AU", emoji: "üê∂üîä" }] },
            1: { items: [
				{ word: "ABA", image: "aba.png", emoji: "üñºÔ∏è" },
				{ word: "BA√ö", image: "bau.png", emoji: "üì¶" },
				{ word: "BAB√Å", image: "baba.png", emoji: "üë∂" },
				{ word: "BOI", emoji: "üêÇ" }, 
				{ word: "BEB√ä", emoji: "üë∂" },
				{ word: "OBA", emoji: "üôå" },
				{ word: "B√â", emoji: "üêêüîä" }] },
            2: { items: [
				{ word: "TATU", image: "tatu.png", emoji: "ü¶î" },
				{ word: "TUBA", image: "tuba.png", emoji: "üé∫" },
				{ word: "TUTU", image: "tutu.png", emoji: "ü©∞" },
				{ word: "BOTE", image: "bote.png", emoji: "üõ∂" },
				{ word: "T√ÅBUA", image: "tabua.png", emoji: "ü™µ" },
				{ word: "BOTA", emoji: "üë¢" },
				{ word: "OITO", emoji: "8Ô∏è‚É£" },
				{ word: "TEIA", emoji: "üï∏Ô∏è" }] },
            3: { items: [
				{ word: "PATA", image: "pata.png", emoji: "üêæ" },
				{ word: "APITO", image: "apito.png", emoji: "üé∫" },
				{ word: "PIU", emoji: "üê§üîä" },
				{ word: "PIPA", emoji: "ü™Å" },
				{ word: "PATO", emoji: "ü¶Ü" },
				{ word: "P√â", emoji: "ü¶∂" }] },
            4: { items: [
				{ word: "DADO", emoji: "üé≤" },
				{ word: "DEDO", emoji: "‚òùÔ∏è" },
				{ word: "DIA", emoji: "üìÖ‚òÄÔ∏è" },
				{ word: "BODE", emoji: "üêê" }] },
            5: { items: [
				{ word: "FADA", emoji: "üßö" },
				{ word: "BIFE", emoji: "üî™ü•©" },
				{ word: "FITA", emoji: "üéóÔ∏è" },
				{ word: "FOTO", emoji: "üì∑" },
				{ word: "FIO", image: "fio.png", emoji: "üßµ" }] },
            6: { items: [
				{ word: "VOV√ì", emoji: "üëµ" },
				{ word: "UVA", emoji: "üçá" },
				{ word: "AVE", image: "ave.png", emoji: "ü¶Üü¶âüêß" },
				{ word: "OVO", emoji: "ü•ö" },
				{ word: "VIVA", emoji: "üéâ" }] },
            7: { items: [ 
				{ word: "MIAU", emoji: "üêàüîä" },
				{ word: "MEIA", emoji: "üß¶" },
				{ word: "MAPA", emoji: "üó∫Ô∏è" },
				{ word: "MUU", emoji: "üêÆüîä" } ] },
            
            // CONTE√öDO DA FASE 8 - ANIMAIS
            8: { items: [
                { word: "MIAU", emoji: "üêàüîä" },
                { word: "AU", emoji: "üê∂üîä" },
                { word: "MUU", emoji: "üêÆüîä" },
                { word: "PIU", emoji: "üê•üîä" },
                { word: "B√â", emoji: "üêêüîä" }
            ]},
            
            9: { items: [{ word: "MENINA", emoji: "üëß" }, { word: "NOVE", emoji: "9Ô∏è‚É£" }, { word: "BON√â", emoji: "üß¢" }, { word: "BANANA", emoji: "üçå" }, { word: "MENINO", emoji: "üë¶" }] },
            10: { items: [{ word: "LUA", emoji: "üåô" }, { word: "LOBO", emoji: "üê∫" }, { word: "BOLA", emoji: "‚öΩ" }, { word: "BALA", emoji: "üç¨" }, { word: "LULA", emoji: "ü¶ë" }] },

            // NOVOS ITEMS
            11: { items: [{ word: "BEIJO", emoji: "üíã" }, { word: "LOJA", emoji: "üè™" }, { word: "JUBA", emoji: "ü¶Å" }, { word: "JIPE", emoji: "üöô" }, { word: "JIL√ì", emoji: "üçà" }] },
            12: { items: [{ word: "CAMA", emoji: "üõèÔ∏è" }, { word: "COLA", emoji: "üß¥" }, { word: "CUBO", emoji: "üßä" }, { word: "COPO", emoji: "ü•õ" }, { word: "BOCA", emoji: "üëÑ" }, { word: "PIPOCA", emoji: "üçø" }] },
            13: { items: [{ word: "SAPO", emoji: "üê∏" }, { word: "SOPA", emoji: "üç≤" }, { word: "SELO", emoji: "‚úâÔ∏è" }, { word: "SAIA", emoji: "üëó" }, { word: "SUCO", emoji: "üßÉ" }] },
            14: { items: [{ word: "RATO", emoji: "üêÅ" }, { word: "REI", emoji: "üëë" }, { word: "RIO", emoji: "üåä" }, { word: "RUA", emoji: "üõ£Ô∏è" }, { word: "ROB√î", emoji: "ü§ñ" }] },
            
            // CORES
            15: { items: [{ word: "AZUL", emoji: "üîµ" }, { word: "ROSA", emoji: "üå∏" }, { word: "VERDE", emoji: "üü¢" }, { word: "LIL√ÅS", emoji: "üü£" }]},

            16: { items: [{ word: "GATO", emoji: "üêà" }, { word: "GALO", emoji: "üêì" }, { word: "GOTA", emoji: "üíß" }, { word: "FOGO", emoji: "üî•" }, { word: "FIGO", emoji: "üçà" }] },
            17: { items: [{ word: "ZERO", emoji: "0Ô∏è‚É£" }, { word: "DOZE", emoji: "1Ô∏è‚É£2Ô∏è‚É£" }, { word: "AZUL", emoji: "üîµ" }, { word: "BUZINA", emoji: "üì¢" }] },
            18: { items: [{ word: "XALE", emoji: "üß£" }, { word: "LIXO", emoji: "üóëÔ∏è" }, { word: "CAIXA", emoji: "üì¶" }, { word: "PEIXE", emoji: "üêü" }, { word: "ROXO", emoji: "üü£" }] },
            
            // --- NOVAS FASES (DATABASE) ---
            19: { items: [{ word: "HARPA", emoji: "üéµ" }, { word: "H√âLICE", emoji: "üöÅ" }, { word: "HIENA", emoji: "üêï" }, { word: "HOTEL", emoji: "üè®" }, { word: "HOJE", emoji: "üìÖ" }] },
            20: { items: [{ word: "LEQUE", emoji: "ü™≠" }, { word: "QUIABO", emoji: "ü•ó" }, { word: "CAQUI", emoji: "üçÖ" }, { word: "QUEIJO", emoji: "üßÄ" }, { word: "AQUI", emoji: "üìç" }] },
            21: { items: [{ word: "KIWI", emoji: "ü•ù" }, { word: "KART", emoji: "üèéÔ∏è" }, { word: "KARAT√ä", emoji: "ü•ã" }, { word: "KETCHUP", emoji: "üå≠" }] },
            22: { items: [{ word: "WAFER", emoji: "üç™" }, { word: "WIFI", emoji: "üì∂" }, { word: "WEBCAM", emoji: "üì∑" }, { word: "WOODY", emoji: "ü§†" }] },
            23: { items: [{ word: "YOGA", emoji: "üßò" }, { word: "YAKISOBA", emoji: "üçú" }, { word: "YOUTUBE", emoji: "‚ñ∂Ô∏è" }, { word: "YURI", emoji: "üë¶üèª" }] },
            
            // CONTEXTO: FRUTAS
            24: { items: [{ word: "MA√á√É", emoji: "üçé" }, { word: "PERA", emoji: "üçê" }, { word: "UVA", emoji: "üçá" }, { word: "CAJU", emoji: "ü•ú" }, { word: "LIM√ÉO", emoji: "üçã" }] },
            // CONTEXTO: CORPO HUMANO
            25: { items: [{ word: "M√ÉO", emoji: "‚úã" }, { word: "P√â", emoji: "ü¶∂" }, { word: "BOCA", emoji: "üëÑ" }, { word: "OLHO", emoji: "üëÅÔ∏è" }, { word: "NARIZ", emoji: "üëÉ" }] },
            
            // --- EXPANS√ÉO ADICIONAL (ITEMS) ---
            26: { items: [{ word: "CHAVE", emoji: "üîë" }, { word: "CHUVA", emoji: "üåßÔ∏è" }, { word: "CH√ÉO", emoji: "üëá" }, { word: "CH√Å", emoji: "‚òï" }, { word: "CHINELO", emoji: "ü©¥" }] },
            27: { items: [{ word: "ILHA", emoji: "üèùÔ∏è" }, { word: "MILHO", emoji: "üåΩ" }, { word: "OLHO", emoji: "üëÅÔ∏è" }, { word: "FOLHA", emoji: "üçÉ" }, { word: "ORELHA", emoji: "üëÇ" }] },
            28: { items: [{ word: "NINHO", emoji: "ü™∫" }, { word: "UNHA", emoji: "üíÖ" }, { word: "SONHO", emoji: "üò¥" }, { word: "BANHO", emoji: "üõÅ" }, { word: "ARANHA", emoji: "üï∑Ô∏è" }] },
            // CONTEXTO: TRANSPORTES
            29: { items: [{ word: "CARRO", emoji: "üöó" }, { word: "AVI√ÉO", emoji: "‚úàÔ∏è" }, { word: "TREM", emoji: "üöÇ" }, { word: "MOTO", emoji: "üèçÔ∏è" }, { word: "√îNIBUS", emoji: "üöå" }] },
            // CONTEXTO: ESCOLA
            30: { items: [{ word: "L√ÅPIS", emoji: "‚úèÔ∏è" }, { word: "LIVRO", emoji: "üìñ" }, { word: "COLA", emoji: "üß¥" }, { word: "MESA", emoji: "ü™ë" }, { word: "MOCHILA", emoji: "üéí" }] },

            // --- NOVOS ITEMS (AT√â 35) ---
            31: { items: [{ word: "CARRO", emoji: "üöó" }, { word: "JARRA", emoji: "üè∫" }, { word: "FERRO", emoji: "‚ô®Ô∏è" }, { word: "GORRO", emoji: "üéÖ" }, { word: "SERROTE", emoji: "ü™ö" }] },
            32: { items: [{ word: "OSSO", emoji: "ü¶¥" }, { word: "P√ÅSSARO", emoji: "üê¶" }, { word: "VASSOURA", emoji: "üßπ" }, { word: "B√öSSOLA", emoji: "üß≠" }, { word: "P√äSSEGO", emoji: "üçë" }] },
            33: { items: [{ word: "LA√áO", emoji: "üéÄ" }, { word: "TA√áA", emoji: "üç∑" }, { word: "PO√áO", emoji: "üï≥Ô∏è" }, { word: "PALHA√áO", emoji: "ü§°" }, { word: "CORA√á√ÉO", emoji: "‚ù§Ô∏è" }] },
            // CONTEXTO: CASA
            34: { items: [{ word: "SOF√Å", emoji: "üõãÔ∏è" }, { word: "PORTA", emoji: "üö™" }, { word: "JANELA", emoji: "ü™ü" }, { word: "TETO", emoji: "üè†" }, { word: "PAREDE", emoji: "üß±" }] },
            // CONTEXTO: SENTIMENTOS
            35: { items: [{ word: "FELIZ", emoji: "üòä" }, { word: "TRISTE", emoji: "üò¢" }, { word: "BRAVO", emoji: "üò†" }, { word: "MEDO", emoji: "üò®" }, { word: "AMOR", emoji: "‚ù§Ô∏è" }] },

             // --- NOVOS ITEMS (AT√â 40) ---
            36: { items: [{ word: "ARCO", emoji: "üèπ" }, { word: "CARTA", emoji: "‚úâÔ∏è" }, { word: "CIRCO", emoji: "üé™" }, { word: "PORTA", emoji: "üö™" }, { word: "URSO", emoji: "üêª" }] },
            37: { items: [{ word: "ANEL", emoji: "üíç" }, { word: "BALDE", emoji: "ü™£" }, { word: "SOL", emoji: "‚òÄÔ∏è" }, { word: "BOLSA", emoji: "üëú" }, { word: "PULGA", emoji: "üêú" }] },
            38: { items: [{ word: "ANJO", emoji: "üëº" }, { word: "DENTE", emoji: "ü¶∑" }, { word: "PENTE", emoji: "ü™Æ" }, { word: "ON√áA", emoji: "üêÜ" }, { word: "MUNDO", emoji: "üåç" }] },
            39: { items: [{ word: "FLOR", emoji: "üå∏" }, { word: "√ÅRVORE", emoji: "üå≥" }, { word: "MAR", emoji: "üåä" }, { word: "PEDRA", emoji: "ü™®" }, { word: "VENTO", emoji: "üå¨Ô∏è" }] },
            40: { items: [{ word: "PULAR", emoji: "üèÉ" }, { word: "COMER", emoji: "üçΩÔ∏è" }, { word: "BEBER", emoji: "ü•§" }, { word: "DORMIR", emoji: "üò¥" }, { word: "RIR", emoji: "üòÇ" }] }
        };

        // --- VARI√ÅVEIS DE ESTADO ---
        let configHints = false;
        let isProgressiveMode = false;
        let isSecondPass = false;
        let difficultyThreshold = 70;
        let currentLevel = 0;
        let score = 0;
        let flowState = 'SETUP'; 
        let gameQueue = [];
        let currentItem = null;
        let currentBoxIndex = 0;
        let presentationQueue = [];
        let presentationIndex = 0;
        let targetIndices = [];
        let learnedLetters = new Set();
        let phaseCorrectAttempts = 0;
        let phaseTotalAttempts = 0;

        // --- SISTEMA DE PERSIST√äNCIA (SALVAR) ---
        function getSavedProgress() {
            const unlocked = localStorage.getItem('digita_max_level') || 0;
            const records = JSON.parse(localStorage.getItem('digita_records') || '{}');
            return { maxLevel: parseInt(unlocked), records: records };
        }

        function saveProgress(level, accuracy) {
            const progress = getSavedProgress();
            if (level + 1 > progress.maxLevel) {
                progress.maxLevel = level + 1;
                localStorage.setItem('digita_max_level', progress.maxLevel);
            }
            const currentRecord = progress.records[level] || 0;
            if (accuracy > currentRecord) {
                progress.records[level] = Math.round(accuracy);
                localStorage.setItem('digita_records', JSON.stringify(progress.records));
            }
        }

        function resetProgress() {
            if(confirm('Tem certeza que deseja apagar todo o progresso?')) {
                localStorage.clear();
                location.reload();
            }
        }

        // --- INICIALIZA√á√ÉO E MENU ---
        window.onload = function() {
            renderLevelGrid();
        };

        function goToMenu() {
            showScreen('SETUP');
            renderLevelGrid();
        }

        function renderLevelGrid() {
            const grid = document.getElementById('levelsGrid');
            grid.innerHTML = '';
            const progress = getSavedProgress();
            const totalLevels = Object.keys(levels).length;

            for (let i = 0; i < totalLevels; i++) {
                const isLocked = i > progress.maxLevel;
                const record = progress.records[i] !== undefined ? progress.records[i] + '%' : null;
                const levelData = levels[i];

                const card = document.createElement('div');
                card.className = `level-card bg-white border-b-4 rounded-2xl p-4 flex flex-col items-center justify-between min-h-[140px] shadow-sm cursor-pointer select-none ${isLocked ? 'level-locked bg-gray-100 border-gray-300' : levelData.color.replace('bg-', 'hover:bg-opacity-80 border-')}`;
                
                let titleDisplay = levelData.title;
                if(titleDisplay.startsWith("Letra ")) titleDisplay = titleDisplay.replace('Letra ', '');

                if (isLocked) {
                    card.innerHTML = `
                        <div class="text-gray-400 text-4xl mb-2">üîí</div>
                        <div class="text-gray-400 font-bold text-lg">Fase ${i}</div>
                        <div class="text-xs text-gray-400 font-bold uppercase mt-2">Bloqueada</div>
                    `;
                } else {
                    card.onclick = () => startGameFromMenu(i);
                    const recordHtml = record ? `<div class="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded-full font-bold shadow-sm">üèÜ ${record}</div>` : `<div class="text-gray-300 text-xs font-bold">--%</div>`;
                    
                    card.innerHTML = `
                        <div class="w-full flex justify-between items-start">
                            <span class="text-gray-400 text-xs font-bold">Fase ${i}</span>
                            ${recordHtml}
                        </div>
                        <div class="text-3xl md:text-4xl font-black mb-1 mt-2 text-center break-words leading-tight">${titleDisplay}</div>
                        <div class="mt-auto w-full bg-black/5 h-1 rounded-full overflow-hidden">
                            <div class="h-full bg-current opacity-30" style="width: ${progress.records[i] || 0}%"></div>
                        </div>
                    `;
                    card.classList.add(levelData.color.split(' ')[1]); 
                }
                grid.appendChild(card);
            }
        }

        function startGameFromMenu(lvl) {
            configHints = document.getElementById('toggleHints').checked;
            isProgressiveMode = document.getElementById('toggleProgressive').checked;
            difficultyThreshold = parseInt(document.getElementById('difficultySelect').value);
            initLevel(lvl);
        }

        function showScreen(screenName) {
            document.getElementById('screenSetup').classList.add('hidden');
            document.getElementById('screenPresentation').classList.add('hidden');
            document.getElementById('screenGame').classList.add('hidden');
            
            if (screenName === 'SETUP') document.getElementById('screenSetup').classList.remove('hidden');
            else if (screenName === 'PRESENTATION') document.getElementById('screenPresentation').classList.remove('hidden');
            else if (screenName === 'GAME') {
                document.getElementById('screenGame').classList.remove('hidden');
                document.getElementById('screenGame').classList.add('flex');
            }
        }

        function initLevel(lvl) {
            currentLevel = lvl;
            isSecondPass = false;
            if (!database[currentLevel]) {
                alert("Parab√©ns! Fim do Jogo.");
                goToMenu();
                return;
            }
            learnedLetters = new Set();
            for(let i=0; i<=currentLevel; i++) {
                if(levels[i] && levels[i].unlock) levels[i].unlock.forEach(l => learnedLetters.add(l));
            }
            startIntroSyllables();
        }

        function startIntroSyllables() {
            flowState = 'INTRO';
            const data = levels[currentLevel];
            let title = "";
            
            // T√≠tulo customizado para fases especiais
            if (data.type === 'context') {
                title = data.introTitle || data.title;
            } else {
                title = currentLevel === 0 ? "As Vogais" : `Fam√≠lia do ${data.title.replace('Letra ','')}`;
            }

            const syllables = data.syllables || [];
            // Ajuste no tamanho da fonte se tiver muitas s√≠labas
            const fontSize = syllables.length > 5 ? 'text-4xl md:text-6xl' : 'text-5xl md:text-7xl';
            
            let html = `<h2 class="text-5xl font-bold text-blue-500 mb-8 animate__animated animate__fadeInDown text-center">${title}</h2><div class="flex justify-center gap-4 flex-wrap mb-6">`;
            syllables.forEach((syl, idx) => {
                html += `<div class="${fontSize} font-bold bg-white text-blue-500 border-4 border-blue-200 rounded-3xl px-6 py-4 shadow-lg animate__animated animate__zoomIn" style="animation-delay: ${idx*100}ms">${syl}</div>`;
            });
            html += `</div>`;
            document.getElementById('presentationTitle').textContent = "INTRODU√á√ÉO";
            document.getElementById('presentationContent').innerHTML = html;
            showScreen('PRESENTATION');
        }

        function startPresentationWords() {
            flowState = 'PRES';
            presentationQueue = [...database[currentLevel].items];
            presentationIndex = 0;
            showNextPresentationWord();
        }

        function showNextPresentationWord() {
            if (presentationIndex >= presentationQueue.length) {
                // Se a fase for de contexto, pula direto para palavras (n√£o tem fase de s√≠laba separada)
                if (currentLevel === 0 || levels[currentLevel].type === 'context') startWordGame();
                else startSyllableGame();
                return;
            }
            const item = presentationQueue[presentationIndex];
            let mediaHtml = item.image ? 
                `<img src="${pathImg + item.image}" class="max-h-60 mx-auto drop-shadow-md animate__animated animate__jackInTheBox" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"> <span style="display:none" class="text-9xl animate__animated animate__jackInTheBox">${item.emoji}</span>` : 
                `<span class="text-9xl animate__animated animate__jackInTheBox">${item.emoji}</span>`;
            let html = `<div class="bg-white border-4 border-purple-200 rounded-3xl p-8 mb-6 shadow-sm w-full max-w-lg mx-auto">${mediaHtml}</div><div class="text-7xl font-bold text-gray-600 tracking-widest uppercase mb-4 animate__animated animate__fadeInUp">${item.word}</div>`;
            document.getElementById('presentationTitle').textContent = "PALAVRAS NOVAS";
            document.getElementById('presentationContent').innerHTML = html;
            showScreen('PRESENTATION');
            playAudio(item.word);
        }

        function advanceLinearFlow() {
            if (flowState === 'INTRO') startPresentationWords();
            else if (flowState === 'PRES') { presentationIndex++; showNextPresentationWord(); }
            else if (flowState === 'TRANSITION_TO_SYL') {
                // Verifica se pula s√≠labas (contexto)
                if (levels[currentLevel].type === 'context') startWordGame();
                else startSyllableGame();
            }
            else if (flowState === 'TRANSITION_TO_WORD') startWordGame();
            else if (flowState === 'END_PHASE') initLevel(currentLevel + 1);
            else if (flowState === 'RETRY') { 
                if (currentLevel === 0 || levels[currentLevel].type === 'context') startWordGame(); 
                else startSyllableGame(); 
            }
        }

        function prepareGameQueue() {
            gameQueue = [...database[currentLevel].items].sort(() => Math.random() - 0.5);
            if (isProgressiveMode && !isSecondPass) configHints = true;
            if (!isSecondPass) { phaseTotalAttempts = 0; phaseCorrectAttempts = 0; }
            updateStatsUI();
        }

        function startSyllableGame() {
            flowState = 'GAME_SYL';
            const letter = levels[currentLevel].title.replace("Letra ", "");
            document.getElementById('gameLevelDisplay').textContent = `Fase ${currentLevel} - ${letter} (S√≠labas)`;
            prepareGameQueue();
            showScreen('GAME');
            renderKeyboard();
            nextGameItem();
        }

        function startWordGame() {
            flowState = 'GAME_WORD';
            const lvlData = levels[currentLevel];
            let titleText = "";
            if (lvlData.type === 'context') {
                titleText = `Fase ${currentLevel} - ${lvlData.title}`;
            } else {
                const letter = lvlData.title.replace("Letra ", "");
                titleText = `Fase ${currentLevel} - ${letter} (Palavras)`;
            }
            
            document.getElementById('gameLevelDisplay').textContent = titleText;
            prepareGameQueue();
            showScreen('GAME');
            renderKeyboard();
            nextGameItem();
        }

        function updateStatsUI() {
            document.getElementById('scoreDisplay').textContent = score;
            let acc = 100;
            if (phaseTotalAttempts > 0) acc = Math.round((phaseCorrectAttempts / phaseTotalAttempts) * 100);
            document.getElementById('accuracyDisplay').textContent = acc + "%";
            
            const accEl = document.getElementById('accuracyDisplay');
            if(acc < difficultyThreshold && difficultyThreshold > 0) {
                accEl.classList.remove('text-green-600'); accEl.classList.add('text-orange-500');
            } else {
                accEl.classList.remove('text-orange-500'); accEl.classList.add('text-green-600');
            }
        }

        function nextGameItem() {
            if (gameQueue.length === 0) { 
                if (isProgressiveMode && !isSecondPass) {
                    isSecondPass = true; 
                    configHints = false; 
                    showIntermission();
                    return;
                }
                checkEndPhase(); 
                isSecondPass = false;
                return; 
            }

            currentItem = gameQueue.pop();
            const total = database[currentLevel].items.length;
            const progress = ((total - gameQueue.length) / total) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            const levelLetter = levels[currentLevel].title.replace("Letra ", "").trim();

            if (flowState === 'GAME_SYL') {
                document.getElementById('gameInstruction').textContent = "Complete a s√≠laba:";
                targetIndices = findSyllableIndices(currentItem.word, levelLetter);
                if (targetIndices.length === 0) targetIndices = Array.from({length: currentItem.word.length}, (_, i) => i);
            } else {
                document.getElementById('gameInstruction').textContent = "Escreva a palavra:";
                targetIndices = Array.from({length: currentItem.word.length}, (_, i) => i);
            }
            renderGameRound();
        }

        function showIntermission() {
            const html = `
                <div class="bg-blue-100 border-4 border-blue-300 rounded-full p-8 mb-6 shadow-sm inline-block animate__animated animate__bounceIn">
                    <span class="text-8xl">üôà</span>
                </div>
                <h2 class="text-4xl font-bold text-blue-600 mb-4 animate__animated animate__fadeIn">Agora sem ajuda!</h2>
                <p class="text-xl text-gray-500 max-w-md mx-auto mb-8">Voc√™ consegue fazer de novo sem as cores?</p>
                <button onclick="startSecondPass()" class="bg-blue-500 hover:bg-blue-400 text-white text-2xl font-bold py-4 px-10 rounded-2xl shadow-[0_6px_0_rgb(37,99,235)] active:shadow-none active:translate-y-2 transition-all uppercase tracking-widest">
                    VAMOS L√Å!
                </button>
            `;
            document.getElementById('presentationTitle').textContent = "DESAFIO";
            document.getElementById('presentationContent').innerHTML = html;
            showScreen('PRESENTATION');
        }

        function startSecondPass() {
            gameQueue = [...database[currentLevel].items].sort(() => Math.random() - 0.5);
            phaseTotalAttempts = 0;
            phaseCorrectAttempts = 0;
            updateStatsUI();
            showScreen('GAME');
            renderKeyboard();
            nextGameItem();
        }

        function renderGameRound() {
            document.getElementById('successOverlay').classList.add('hidden');
            
            const imgContainer = document.getElementById('gameImageContainer');
            if (currentItem.image) {
                imgContainer.innerHTML = `<img src="${pathImg + currentItem.image}" class="max-h-full max-w-full object-contain animate__animated animate__fadeIn" onerror="this.outerHTML='<span class=\\'text-8xl\\'>${currentItem.emoji}</span>'">`;
            } else {
                imgContainer.innerHTML = `<span class="text-8xl animate__animated animate__fadeIn">${currentItem.emoji}</span>`;
            }
            
            playAudio(currentItem.word);

            const container = document.getElementById('inputContainer');
            container.innerHTML = '';
            currentBoxIndex = targetIndices[0];

            for (let i = 0; i < currentItem.word.length; i++) {
                const div = document.createElement('div');
                div.className = 'letter-box w-12 h-14 md:w-16 md:h-20 border-4 rounded-xl flex items-center justify-center text-3xl md:text-5xl font-bold shadow-sm bg-white m-1';
                div.id = `box-${i}`;
                if (!targetIndices.includes(i)) {
                    div.classList.add('filled-static');
                    div.textContent = currentItem.word[i];
                } else {
                    div.classList.add('text-gray-700', 'border-gray-300');
                }
                container.appendChild(div);
            }
            updateActiveBox();
            setTimeout(updateKeyboardHints, 50);
        }

        function handleInput(char) {
            if (!document.getElementById('successOverlay').classList.contains('hidden')) return;
            if (currentBoxIndex >= currentItem.word.length) return;
            
            while (currentBoxIndex < currentItem.word.length && !targetIndices.includes(currentBoxIndex)) currentBoxIndex++;
            if (currentBoxIndex >= currentItem.word.length) return;

            phaseTotalAttempts++;
            const targetChar = currentItem.word[currentBoxIndex];
            const normInput = char.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const normTarget = targetChar.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

            if (normInput === normTarget) {
                phaseCorrectAttempts++;
                const box = document.getElementById(`box-${currentBoxIndex}`);
                if(box) {
                    box.textContent = targetChar;
                    box.classList.remove('active-box');
                    box.classList.add('correct', 'animate__animated', 'animate__bounceIn');
                }
                
                document.getElementById('sndCorrect').currentTime = 0; 
                document.getElementById('sndCorrect').play();

                currentBoxIndex++;
                while (currentBoxIndex < currentItem.word.length && !targetIndices.includes(currentBoxIndex)) currentBoxIndex++;

                if (currentBoxIndex >= currentItem.word.length) {
                    roundWon();
                } else {
                    updateActiveBox();
                    updateKeyboardHints();
                }
            } else {
                const box = document.getElementById(`box-${currentBoxIndex}`);
                if(box) {
                    box.classList.add('incorrect');
                    setTimeout(() => box.classList.remove('incorrect'), 400);
                }
            }
            updateStatsUI();
        }

        function roundWon() {
            const overlay = document.getElementById('successOverlay');
            overlay.classList.remove('hidden');
            
            document.getElementById('sndWordWin').currentTime = 0; 
            document.getElementById('sndWordWin').play();
            score += 10;
            updateStatsUI();
            fireConfetti();
            document.querySelectorAll('.key').forEach(k => k.classList.remove('hint-active', 'hint-inactive'));
        }

        function checkEndPhase() {
            const acc = phaseTotalAttempts === 0 ? 0 : (phaseCorrectAttempts / phaseTotalAttempts) * 100;
            let title, msg, nextState, buttonText = "PR√ìXIMO ‚ûî";
            
            if (acc < difficultyThreshold) {
                document.getElementById('sndLose').play();
                title = "Vamos tentar de novo?"; 
                msg = `Voc√™ fez ${Math.round(acc)}%. Precisa de ${difficultyThreshold}% para passar.`; 
                nextState = 'RETRY';
                buttonText = "TENTAR DE NOVO ‚Ü∫";
                document.getElementById('presentationTitle').textContent = "REVIS√ÉO";
            } else {
                document.getElementById('sndLevelWin').play();
                if (flowState === 'GAME_SYL') {
                    title = "S√≠labas Completas!"; 
                    msg = "Agora vamos escrever as palavras inteiras."; 
                    nextState = 'TRANSITION_TO_WORD';
                } else {
                    title = "N√≠vel Conclu√≠do!";
                    const nextLvl = levels[currentLevel + 1];
                    msg = nextLvl ? `Voc√™ desbloqueou: ${nextLvl.title}` : "Voc√™ terminou o jogo!";
                    nextState = 'END_PHASE';
                    saveProgress(currentLevel, acc);
                }
                document.getElementById('presentationTitle').textContent = "PARAB√âNS";
            }
            
            flowState = nextState;
            const isFail = nextState === 'RETRY';
            const colorClass = isFail ? 'text-orange-500' : 'text-green-500';
            const borderClass = isFail ? 'border-orange-200' : 'border-green-200';
            const emoji = isFail ? 'üí™' : '‚≠ê';

            const actionBtn = document.querySelector('#screenPresentation button[onclick="advanceLinearFlow()"]');
            actionBtn.textContent = buttonText;
            if(isFail) {
                 actionBtn.classList.replace('bg-green-500', 'bg-orange-500');
                 actionBtn.classList.replace('shadow-[0_6px_0_rgb(21,128,61)]', 'shadow-[0_6px_0_rgb(249,115,22)]');
            } else {
                 actionBtn.classList.replace('bg-orange-500', 'bg-green-500');
                 actionBtn.classList.replace('shadow-[0_6px_0_rgb(249,115,22)]', 'shadow-[0_6px_0_rgb(21,128,61)]');
            }

            let html = `<div class="bg-white border-4 ${borderClass} rounded-full p-10 mb-6 shadow-sm inline-block"><span class="text-8xl">${emoji}</span></div><h2 class="text-4xl font-bold ${colorClass} mb-4">${title}</h2><p class="text-xl text-gray-500 max-w-md mx-auto">${msg}</p>`;
            document.getElementById('presentationContent').innerHTML = html;
            showScreen('PRESENTATION');
        }

        function renderKeyboard() {
            const layout = ["QWERTYUIOP", "ASDFGHJKL", "ZXCVBNM"];
            const container = document.getElementById('keyboardContainer'); 
            container.innerHTML = '';
            layout.forEach(row => {
                const rowDiv = document.createElement('div'); rowDiv.className = "flex justify-center gap-1";
                row.split('').forEach(char => {
                    const btn = document.createElement('button'); btn.textContent = char; btn.id = `key-${char}`;
                    let btnClass = "key"; if (learnedLetters.has(char)) btnClass += " key-learned";
                    btn.className = btnClass;
                    btn.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(char); btn.classList.add('active-press'); });
                    btn.addEventListener('touchend', (e) => { e.preventDefault(); btn.classList.remove('active-press'); });
                    btn.addEventListener('click', (e) => { handleInput(char); });
                    rowDiv.appendChild(btn);
                });
                container.appendChild(rowDiv);
            });
        }

        function updateKeyboardHints() {
            document.querySelectorAll('.key').forEach(k => k.classList.remove('hint-active', 'hint-inactive'));

            if (!configHints || !currentItem || !document.getElementById('successOverlay').classList.contains('hidden')) return;
            
            let tempIndex = currentBoxIndex;
            while (tempIndex < currentItem.word.length && !targetIndices.includes(tempIndex)) tempIndex++;
            
            if (tempIndex < currentItem.word.length) {
                const targetChar = currentItem.word[tempIndex].normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                document.querySelectorAll('.key').forEach(k => {
                    const keyChar = k.textContent.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    if (keyChar === targetChar) k.classList.add('hint-active');
                    else k.classList.add('hint-inactive');
                });
            }
        }

        function updateActiveBox() {
            document.querySelectorAll('.letter-box').forEach(b => b.classList.remove('active-box'));
            let tempIndex = currentBoxIndex;
            while (tempIndex < currentItem.word.length && !targetIndices.includes(tempIndex)) tempIndex++;
            if (tempIndex < currentItem.word.length) { 
                const current = document.getElementById(`box-${tempIndex}`); 
                if (current) current.classList.add('active-box'); 
            }
        }

        function findSyllableIndices(word, levelLetter) {
            const indices = [];
            const regex = new RegExp(`(${levelLetter})[AEOIU√Å√â√ç√ì√ö√É√ï√Ç√ä√î]`, 'i');
            const match = word.match(regex);
            
            if (match && match.index !== undefined) { 
                indices.push(match.index, match.index + 1); 
            }
            else if (word.toUpperCase().startsWith(levelLetter)) { 
                indices.push(0, 1); 
                if(word.length < 2) indices.push(0); 
            }
            return indices;
        }

        function playAudio(text) {
            const fn = text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") + ".mp3";
            new Audio(pathAudio + fn).play().catch(()=>{});
        }
        window.playCurrentAudio = () => { if(currentItem) playAudio(currentItem.word); };

        const canvas = document.getElementById('confetti-canvas'); const ctx = canvas.getContext('2d'); let particles = [];
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas); resizeCanvas();
        function fireConfetti() { for (let i = 0; i < 100; i++) particles.push({ x: window.innerWidth/2, y: window.innerHeight/2, vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15, size: Math.random()*8+4, color: `hsl(${Math.random()*360},100%,50%)`, life: 100 }); requestAnimationFrame(animateConfetti); }
        function animateConfetti() { ctx.clearRect(0, 0, canvas.width, canvas.height); particles = particles.filter(p => p.life > 0); particles.forEach(p => { p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life--; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill(); }); if (particles.length > 0) requestAnimationFrame(animateConfetti); }
    </script>
</body>
</html>